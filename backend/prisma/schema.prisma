generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER ROLES: Admin & Moderation System
// ============================================
enum UserRole {
  USER
  MODERATOR
  ADMIN
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  password     String
  nombre       String
  apellido     String?
  avatar       String?
  bio          String?
  region       String?
  isPublic     Boolean   @default(true)
  role         UserRole  @default(USER)
  bannedAt     DateTime?
  bannedReason String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  stories           Story[]
  likes             Like[]
  comments          Comment[]
  conversations     Conversation[]
  pushSubscriptions PushSubscription[]

  // Social relations
  followers     Follow[] @relation("UserFollowing")
  following     Follow[] @relation("UserFollowers")

  // Gamification relations
  badges        UserBadge[]
  stats         UserStats?

  // Notification relations
  notifications Notification[]

  // Direct Messages relations
  conversationsAsParticipant1 DirectConversation[] @relation("ConversationParticipant1")
  conversationsAsParticipant2 DirectConversation[] @relation("ConversationParticipant2")
  directMessages              DirectMessage[]

  // Event relations
  eventRSVPs     EventRSVP[]
  eventReminders EventReminder[]

  // Analytics relations
  activityLogs ActivityLog[]

  // Community relations
  createdCommunities Community[]       @relation("CommunityCreator")
  communityMembers   CommunityMember[]
  communityPosts     CommunityPost[]

  // Marketplace relations
  sellerProfile   SellerProfile?
  cart            Cart?
  orders          Order[]
  productReviews  ProductReview[]

  // Streaming relations
  streams         LiveStream[]
  streamMessages  StreamMessage[]

  // AR Map relations
  poiReviews      POIReview[]
  poiFavorites    POIFavorite[]
  poiCheckIns     POICheckIn[]

  // Reservations relations
  hostedExperiences   Experience[]
  bookings            Booking[]
  experienceReviews   ExperienceReview[]
}

model Story {
  id           String    @id @default(cuid())
  description  String
  mediaUrl     String
  mediaType    MediaType @default(IMAGE)
  thumbnailUrl String?
  duration     Int?
  location     String
  views        Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  userId   String
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes    Like[]
  comments Comment[]
}

enum MediaType {
  IMAGE
  VIDEO
}

model Like {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId  String
  storyId String
  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  story   Story @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([userId, storyId])
}

model Comment {
  id        String   @id @default(cuid())
  text      String
  createdAt DateTime @default(now())

  userId  String
  storyId String
  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  story   Story @relation(fields: [storyId], references: [id], onDelete: Cascade)
}

model BusRoute {
  id          String    @id @default(cuid())
  routeCode   String    @unique
  name        String
  color       String
  type        RouteType
  description String?
  startTime   String?
  endTime     String?
  frequency   Int?

  stops Stop[]
  buses Bus[]
}

enum RouteType {
  TRONCAL
  ESPECIAL
  PEATONAL
}

model Stop {
  id        String @id @default(cuid())
  name      String
  latitude  Float
  longitude Float
  sequence  Int

  routeId String
  route   BusRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)
}

model Bus {
  id            String  @id @default(cuid())
  busCode       String  @unique
  latitude      Float?
  longitude     Float?
  heading       Float?
  speed         Float?
  capacity      Int     @default(40)
  occupied      Int     @default(0)
  currentStopId String?

  routeId String
  route   BusRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)
}

model Conversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId   String
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]
}

model Message {
  id        String   @id @default(cuid())
  role      Role
  text      String
  createdAt DateTime @default(now())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

enum Role {
  user
  model
}

model PushSubscription {
  id        String   @id @default(cuid())
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// SOCIAL: Followers System
// ============================================
model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// ============================================
// GAMIFICATION: Badges & XP System
// ============================================
model Badge {
  id          String        @id @default(cuid())
  code        String        @unique
  name        String
  description String
  icon        String
  xpReward    Int           @default(0)
  category    BadgeCategory
  threshold   Int           @default(1)
  createdAt   DateTime      @default(now())

  userBadges UserBadge[]
}

enum BadgeCategory {
  STORIES
  SOCIAL
  ENGAGEMENT
  STREAK
  SPECIAL
}

model UserBadge {
  id         String   @id @default(cuid())
  userId     String
  badgeId    String
  unlockedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
}

model UserStats {
  id            String    @id @default(cuid())
  userId        String    @unique
  xp            Int       @default(0)
  level         Int       @default(1)
  currentStreak Int       @default(0)
  longestStreak Int       @default(0)
  lastVisitDate DateTime?
  updatedAt     DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// NOTIFICATIONS: Real-time System
// ============================================
model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  data      Json?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
}

enum NotificationType {
  NEW_FOLLOWER
  LIKE
  COMMENT
  BADGE_UNLOCKED
  LEVEL_UP
  DIRECT_MESSAGE
  EVENT_REMINDER
  SYSTEM
}

// ============================================
// DIRECT MESSAGES: User-to-User Chat
// ============================================
model DirectConversation {
  id             String    @id @default(cuid())
  participant1Id String
  participant2Id String
  lastMessageAt  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  participant1 User            @relation("ConversationParticipant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2 User            @relation("ConversationParticipant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  messages     DirectMessage[]

  @@unique([participant1Id, participant2Id])
  @@index([participant1Id])
  @@index([participant2Id])
}

model DirectMessage {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  read           Boolean  @default(false)
  createdAt      DateTime @default(now())

  conversation DirectConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User               @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

// ============================================
// EVENTS: Guelaguetza Calendar & RSVP
// ============================================
model Event {
  id          String        @id @default(cuid())
  title       String
  description String
  imageUrl    String?
  location    String
  latitude    Float?
  longitude   Float?
  startDate   DateTime
  endDate     DateTime?
  category    EventCategory
  isOfficial  Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  rsvps     EventRSVP[]
  reminders EventReminder[]

  @@index([startDate])
  @@index([category])
}

enum EventCategory {
  DANZA
  MUSICA
  GASTRONOMIA
  ARTESANIA
  CEREMONIA
  DESFILE
  OTRO
}

model EventRSVP {
  id        String   @id @default(cuid())
  userId    String
  eventId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
}

model EventReminder {
  id        String   @id @default(cuid())
  userId    String
  eventId   String
  remindAt  DateTime
  sent      Boolean  @default(false)
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
}

// ============================================
// ANALYTICS: Activity Logging
// ============================================
model ActivityLog {
  id         String   @id @default(cuid())
  userId     String
  action     String   // CREATE_STORY, LIKE, COMMENT, FOLLOW, VIEW_STORY, etc.
  targetType String?  // STORY, USER, COMMENT, COMMUNITY, EVENT
  targetId   String?
  metadata   Json?    // Additional context data
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([targetType, targetId])
}

// ============================================
// COMMUNITIES: Groups & Discussions
// ============================================
model Community {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  imageUrl    String?
  coverUrl    String?
  isPublic    Boolean  @default(true)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy User              @relation("CommunityCreator", fields: [createdById], references: [id])
  members   CommunityMember[]
  posts     CommunityPost[]

  @@index([slug])
  @@index([createdById])
}

enum CommunityRole {
  MEMBER
  MODERATOR
  ADMIN
}

model CommunityMember {
  id          String        @id @default(cuid())
  userId      String
  communityId String
  role        CommunityRole @default(MEMBER)
  joinedAt    DateTime      @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([communityId])
}

model CommunityPost {
  id          String   @id @default(cuid())
  communityId String
  authorId    String
  content     String
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  author    User      @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([communityId, createdAt])
}

// ============================================
// MARKETPLACE: E-commerce System
// ============================================
enum ProductCategory {
  ARTESANIA
  MEZCAL
  TEXTIL
  CERAMICA
  JOYERIA
  GASTRONOMIA
  OTRO
}

enum ProductStatus {
  DRAFT
  ACTIVE
  SOLD_OUT
  ARCHIVED
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

model SellerProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  businessName    String
  description     String?
  bannerUrl       String?
  location        String?
  rating          Float    @default(0)
  reviewCount     Int      @default(0)
  verified        Boolean  @default(false)
  stripeAccountId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  products Product[]
  orders   Order[]

  @@index([userId])
}

model Product {
  id          String          @id @default(cuid())
  sellerId    String
  name        String
  description String
  price       Decimal         @db.Decimal(10, 2)
  category    ProductCategory
  status      ProductStatus   @default(DRAFT)
  stock       Int             @default(0)
  images      String[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  seller     SellerProfile   @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  cartItems  CartItem[]
  orderItems OrderItem[]
  reviews    ProductReview[]

  @@index([sellerId])
  @@index([category, status])
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]
}

model CartItem {
  id        String @id @default(cuid())
  cartId    String
  productId String
  quantity  Int    @default(1)

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
}

model Order {
  id              String      @id @default(cuid())
  userId          String
  sellerId        String
  status          OrderStatus @default(PENDING)
  total           Decimal     @db.Decimal(10, 2)
  shippingAddress Json
  stripePaymentId String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user   User          @relation(fields: [userId], references: [id])
  seller SellerProfile @relation(fields: [sellerId], references: [id])
  items  OrderItem[]

  @@index([userId])
  @@index([sellerId])
  @@index([status])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
}

model ProductReview {
  id        String   @id @default(cuid())
  userId    String
  productId String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
}

// ============================================
// STREAMING: Live Video System
// ============================================
enum StreamStatus {
  SCHEDULED
  LIVE
  ENDED
}

enum StreamCategory {
  DANZA
  MUSICA
  ARTESANIA
  COCINA
  CHARLA
  OTRO
}

model LiveStream {
  id           String         @id @default(cuid())
  userId       String
  title        String
  description  String?
  thumbnailUrl String?
  category     StreamCategory
  status       StreamStatus   @default(SCHEDULED)
  scheduledAt  DateTime?
  startedAt    DateTime?
  endedAt      DateTime?
  viewerCount  Int            @default(0)
  peakViewers  Int            @default(0)
  streamKey    String         @unique @default(cuid())
  playbackUrl  String?
  vodUrl       String?
  createdAt    DateTime       @default(now())

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages StreamMessage[]

  @@index([userId])
  @@index([status])
  @@index([category])
}

model StreamMessage {
  id        String   @id @default(cuid())
  streamId  String
  userId    String
  content   String
  createdAt DateTime @default(now())

  stream LiveStream @relation(fields: [streamId], references: [id], onDelete: Cascade)
  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([streamId, createdAt])
}

// ============================================
// AR MAP: Points of Interest
// ============================================
enum POICategory {
  CULTURAL
  GASTRONOMIA
  ARTESANIA
  EVENTO
  TRANSPORTE
  NATURALEZA
}

model PointOfInterest {
  id          String      @id @default(cuid())
  name        String
  description String
  imageUrl    String?
  arModelUrl  String?
  category    POICategory
  latitude    Float
  longitude   Float
  address     String?
  rating      Float       @default(0)
  reviewCount Int         @default(0)
  isVerified  Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  reviews   POIReview[]
  favorites POIFavorite[]
  checkIns  POICheckIn[]

  @@index([category])
  @@index([latitude, longitude])
}

model POIReview {
  id        String   @id @default(cuid())
  userId    String
  poiId     String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  user User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  poi  PointOfInterest @relation(fields: [poiId], references: [id], onDelete: Cascade)

  @@unique([userId, poiId])
}

model POIFavorite {
  id        String   @id @default(cuid())
  userId    String
  poiId     String
  createdAt DateTime @default(now())

  user User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  poi  PointOfInterest @relation(fields: [poiId], references: [id], onDelete: Cascade)

  @@unique([userId, poiId])
}

model POICheckIn {
  id        String   @id @default(cuid())
  userId    String
  poiId     String
  createdAt DateTime @default(now())

  user User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  poi  PointOfInterest @relation(fields: [poiId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([poiId])
}

// ============================================
// RESERVATIONS: Tours & Experiences
// ============================================
enum ExperienceCategory {
  TOUR
  TALLER
  DEGUSTACION
  CLASE
  VISITA
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

model Experience {
  id          String             @id @default(cuid())
  hostId      String
  title       String
  description String
  imageUrl    String?
  images      String[]
  category    ExperienceCategory
  price       Decimal            @db.Decimal(10, 2)
  duration    Int                // Duration in minutes
  maxCapacity Int
  location    String
  latitude    Float?
  longitude   Float?
  includes    String[]
  languages   String[]
  isActive    Boolean            @default(true)
  rating      Float              @default(0)
  reviewCount Int                @default(0)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  host      User                 @relation(fields: [hostId], references: [id])
  timeSlots ExperienceTimeSlot[]
  bookings  Booking[]
  reviews   ExperienceReview[]

  @@index([hostId])
  @@index([category])
  @@index([isActive])
}

model ExperienceTimeSlot {
  id           String   @id @default(cuid())
  experienceId String
  date         DateTime @db.Date
  startTime    String   // "HH:mm" format
  endTime      String
  capacity     Int
  bookedCount  Int      @default(0)
  isAvailable  Boolean  @default(true)
  createdAt    DateTime @default(now())

  experience Experience @relation(fields: [experienceId], references: [id], onDelete: Cascade)
  bookings   Booking[]

  @@index([experienceId, date])
  @@index([date, isAvailable])
}

model Booking {
  id              String        @id @default(cuid())
  userId          String
  experienceId    String
  timeSlotId      String
  status          BookingStatus @default(PENDING)
  guestCount      Int           @default(1)
  totalPrice      Decimal       @db.Decimal(10, 2)
  specialRequests String?
  stripePaymentId String?
  confirmedAt     DateTime?
  cancelledAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user       User               @relation(fields: [userId], references: [id])
  experience Experience         @relation(fields: [experienceId], references: [id])
  timeSlot   ExperienceTimeSlot @relation(fields: [timeSlotId], references: [id])

  @@index([userId])
  @@index([experienceId])
  @@index([timeSlotId])
  @@index([status])
}

model ExperienceReview {
  id           String   @id @default(cuid())
  userId       String
  experienceId String
  rating       Int
  comment      String?
  createdAt    DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  experience Experience @relation(fields: [experienceId], references: [id], onDelete: Cascade)

  @@unique([userId, experienceId])
}
